<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Charm Store — Конструктор украшений и каталог</title>
  <meta name="description" content="Charm Store — конструктор браслетов, ожерелий и брелоков плюс готовый каталог." />
  <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%23F7C9D4'/%3E%3Cstop offset='1' stop-color='%23F5E9E2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='128' height='128' fill='url(%23g)'/%3E%3Ctext x='50%25' y='55%25' text-anchor='middle' font-family='Arial' font-size='54' fill='black'%3ECS%3C/text%3E%3C/svg%3E" />
  <style>
    :root{ --pink:#F7C9D4; --beige:#F5E9E2; --white:#ffffff; --ink:#000; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.08) }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); background:linear-gradient(180deg, var(--beige), var(--white) 40%)}
    .container{width:min(1100px,92%);margin:0 auto}
    .btn{border:1px solid var(--ink);background:var(--pink);color:var(--ink);border-radius:999px;padding:10px 18px;cursor:pointer;transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn-outline{background:transparent}
    .btn-primary{background:var(--pink)}
    .btn.small{padding:6px 10px;border-radius:8px}
    .btn.icon{display:inline-flex;align-items:center;gap:6px}
    .btn.danger{background:#fff3f3;border-color:#af1e1e}

    /* Header */
    .site-header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.75);backdrop-filter:blur(8px);border-bottom:1px solid #00000010}
    .header-inner{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
    .brand{display:flex;align-items:center;gap:10px}
    .avatar{width:34px;height:34px;border-radius:50%;border:1px solid #00000030;object-fit:cover;background:#fff}
    .brand-name{font-size:20px;margin:0;line-height:1}
    .brand-tag{margin:0;font-size:12px;opacity:.8}
    .nav{display:flex;align-items:center;gap:14px}
    .nav a{color:var(--ink);text-decoration:none;padding:6px 10px;border-radius:8px}
    .nav a:hover{background:var(--beige)}
    .hamburger{border:1px solid var(--ink);background:transparent;border-radius:10px;padding:8px 10px;cursor:pointer;display:flex;gap:6px;align-items:center}

    /* Sidebar */
    .sidebar{position:fixed;inset:0 0 0 auto; width:280px; transform:translateX(100%); transition:.25s ease; z-index:30}
    .sidebar.open{transform:translateX(0)}
    .sidebar .panel{position:absolute;right:0;top:0;height:100%;width:280px;background:#fff;border-left:1px solid #00000010;box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:12px}
    .sidebar .title{font-weight:700;margin:4px 0 8px}
    .sidebar a{color:var(--ink);text-decoration:none;padding:10px 12px;border:1px solid #00000020;border-radius:12px;background:#F5E9E2}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.25s}
    .sidebar.open~.backdrop{opacity:1;pointer-events:auto}

    /* Sections */
    .hero{padding:40px 0}
    .hero-inner{display:grid;grid-template-columns:1.1fr .9fr;gap:24px;align-items:center}
    .hero-text h2{font-size:34px;margin:0 0 10px}
    .hero-text p{margin:0 0 18px;max-width:60ch}
    .hero-card{background:var(--white);border:1px solid #00000010;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .hero-img{height:240px;border-radius:10px;border:1px dashed #00000040;background:radial-gradient(100px 100px at 20% 30%, #ffffffcc, transparent), linear-gradient(135deg,var(--pink),var(--beige))}
    .section-head h3{font-size:26px;margin:0 0 6px}
    .section-head p{margin:0 0 14px;opacity:.9}
    .about,.contact,.constructor,.catalog-section{padding:36px 0}

    /* Catalog grid */
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 16px}
    .filter-btn{border:1px solid var(--ink);background:transparent;padding:8px 14px;border-radius:999px;cursor:pointer}
    .filter-btn.active,.filter-btn:hover{background:#F5E9E2}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media(max-width:1000px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:480px){.grid{grid-template-columns:1fr}}
    .card{background:var(--white);border:1px solid #00000010;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .card-img{width:100%;aspect-ratio:1/1;object-fit:cover;background:#fff;border-bottom:1px solid #00000010}
    .card-body{padding:12px}
    .card-title{margin:0 0 6px;font-weight:600}
    .card-price{margin:0 0 10px;font-weight:600}
    .card-desc{margin:0;font-size:14px;opacity:.85}
    .empty{opacity:.7;text-align:center;padding:20px}

    /* Constructor */
    .constructor .wrap{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media(max-width:900px){ .constructor .wrap{grid-template-columns:1fr} }
    .panel{background:#fff;border:1px solid #00000010;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .picker{display:grid;gap:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #00000030;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
    .chip .dot{width:18px;height:18px;border-radius:50%;border:1px solid #00000040}
    .chip.active,.chip:hover{background:#F5E9E2}
    .beads{display:flex;flex-wrap:wrap;gap:8px}
    .bead{display:flex;align-items:center;gap:6px;border:1px solid #00000030;border-radius:999px;padding:6px 10px;background:#fff}
    .bead .sw{width:16px;height:16px;border-radius:50%;border:1px solid #00000040}
    .design{display:flex;flex-direction:column;gap:12px}
    .strand{display:flex;flex-wrap:wrap;gap:8px;min-height:48px;border:1px dashed #00000030;border-radius:12px;padding:10px;background:var(--white)}
    .bead-pill{display:flex;align-items:center;gap:6px;border:1px solid #00000030;border-radius:999px;padding:6px 8px;background:#fff}
    .bead-pill .sw{width:14px;height:14px;border-radius:50%;border:1px solid #00000040}
    .pill-actions button{border:1px solid #00000030;background:transparent;border-radius:6px;padding:2px 6px;cursor:pointer}
    .totals{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .totals .badge{border:1px solid #00000030;padding:6px 10px;border-radius:999px;background:#fff}
    .note{font-size:12px;opacity:.8}

    /* Footer */
    .site-footer{border-top:1px solid #00000010;padding:16px 0;background:rgba(255,255,255,.6)}
    .footer-inner{display:flex;align-items:center;justify-content:space-between}
    .mini-nav a{color:var(--ink);text-decoration:none;margin-left:12px}

    /* Floating WhatsApp button */
    .fab-wa{position:fixed;right:16px;bottom:16px;z-index:40;border:1px solid var(--ink);background:var(--pink);padding:12px 16px;border-radius:999px;text-decoration:none;color:var(--ink);box-shadow:var(--shadow)}
    .fab-wa:hover{transform:translateY(-1px)}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <img id="avatar" class="avatar" alt="Аватар Charm Store"/>
        <div class="brand-text">
          <h1 class="brand-name">Charm Store</h1>
          <p class="brand-tag">Конструктор украшений • Каталог</p>
        </div>
      </div>
      <nav class="nav">
        <a href="#home">Главная</a>
        <a href="#constructor">Конструктор</a>
        <a href="#catalog">Каталог</a>
        <a href="#about">О магазине</a>
        <a href="#contact">Контакты</a>
        <button id="openAddModal" class="btn btn-outline">Добавить товар</button>
        <button id="setAvatarBtn" class="btn btn-outline">Аватар</button>
        <input id="avatarFile" type="file" accept="image/*" hidden />
        <button id="openSidebar" class="hamburger" title="Меню">☰ Меню</button>
      </nav>
    </div>
  </header>

  <!-- Sidebar drawer -->
  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <div class="panel">
      <div class="title">Навигация</div>
      <a href="#home" class="side-link">Главная</a>
      <a href="#constructor" class="side-link">Конструктор</a>
      <a href="#catalog" class="side-link">Каталог</a>
      <a href="#about" class="side-link">О магазине</a>
      <a id="igLink" href="https://instagram.com/charmstore" target="_blank" class="side-link">Наш Instagram</a>
      <a id="waLink" target="_blank" class="side-link">Для заказа — WhatsApp</a>
      <div style="display:flex; gap:8px; margin-top:4px">
        <button id="editIG" class="btn btn-outline small" title="Изменить Instagram">Изм. Instagram</button>
      </div>
      <button id="closeSidebar" class="btn btn-outline" style="margin-top:auto">Закрыть</button>
    </div>
  </aside>
  <div class="backdrop" id="backdrop"></div>

  <main id="home">
    <section class="hero">
      <div class="container hero-inner">
        <div class="hero-text">
          <h2>Создай своё украшение онлайн</h2>
          <p>Выбирай бусины: жемчуг, керамика и другие материалы — собери браслет, ожерелье или брелок, увидь цену и отправь заказ в WhatsApp.</p>
          <a href="#constructor" class="btn btn-primary">Открыть конструктор</a>
        </div>
        <div class="hero-card"><div class="hero-img" role="img" aria-label="Конструктор украшений"></div></div>
      </div>
    </section>

    <!-- Constructor -->
    <section id="constructor" class="constructor">
      <div class="container">
        <div class="section-head">
          <h3>Конструктор</h3>
          <p>Соберите <strong>брелок</strong>, <strong>браслет</strong> или <strong>ожерелье</strong> из любимых бусин.</p>
        </div>
        <div class="wrap">
          <div class="panel picker">
            <div class="row">
              <span class="note">Тип изделия:</span>
              <button class="chip" data-type="keychain"><span class="dot"></span>Брелок</button>
              <button class="chip" data-type="bracelet"><span class="dot"></span>Браслет</button>
              <button class="chip" data-type="necklace"><span class="dot"></span>Ожерелье</button>
            </div>
            <div class="row">
              <span class="note">Размер (длина):</span>
              <button class="chip" data-size="keychain:12">12 см</button>
              <button class="chip" data-size="bracelet:17">17 см</button>
              <button class="chip" data-size="bracelet:19">19 см</button>
              <button class="chip" data-size="necklace:40">40 см</button>
              <button class="chip" data-size="necklace:45">45 см</button>
            </div>
            <div>
              <div class="note">Материалы</div>
              <div id="beadsList" class="beads"></div>
            </div>
          </div>
          <div class="panel design">
            <div class="row" style="justify-content:space-between;align-items:center">
              <strong>Ваш дизайн</strong>
              <div class="row">
                <button id="clearDesign" class="btn btn-outline small">Очистить</button>
                <button id="exportDesign" class="btn btn-outline small">Экспорт</button>
                <input id="importFile" type="file" accept="application/json" hidden />
                <button id="importDesign" class="btn btn-outline small">Импорт</button>
              </div>
            </div>
            <div id="strand" class="strand" aria-label="Нить с бусинами"></div>
            <div class="totals">
              <span class="badge">Тип: <span id="t_type">—</span></span>
              <span class="badge">Длина: <span id="t_length">—</span></span>
              <span class="badge">Бусин: <span id="t_count">0</span></span>
              <span class="badge">Стоимость: <span id="t_price">0 ₸</span></span>
            </div>
            <label class="row" style="gap:8px"><span class="note">Комментарий к заказу:</span>
              <input id="userNote" type="text" placeholder="Напр.: размер 17 см, застёжка золото" style="flex:1; padding:8px 10px; border-radius:10px; border:1px solid #00000040"/>
            </label>
            <div class="row" style="justify-content:flex-end; gap:10px">
              <button id="orderWA" class="btn btn-primary icon">Заказать в WhatsApp</button>
            </div>
            <div class="note">Подсказка: нажимайте на материалы, чтобы добавлять бусины; у каждой бусины можно перемещать позицию ◀ ▶ и удалять ✕.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Catalog -->
    <section id="catalog" class="catalog-section">
      <div class="container">
        <div class="section-head">
          <h3>Готовые украшения</h3>
          <p>Можно купить сразу — или открыть конструктор и собрать своё.</p>
        </div>
        <div class="filters">
          <button class="filter-btn active" data-filter="all">Все</button>
          <button class="filter-btn" data-filter="necklaces">Ожерелья</button>
          <button class="filter-btn" data-filter="bracelets">Браслеты</button>
          <button class="filter-btn" data-filter="rings">Кольца</button>
          <button class="filter-btn" data-filter="chains">Цепочки</button>
        </div>
        <div id="productsGrid" class="grid"></div>
        <p id="emptyState" class="empty" hidden>Пока нет товаров. Нажмите «Добавить товар», чтобы загрузить фото.</p>
      </div>
    </section>

    <!-- About -->
    <section id="about" class="about">
      <div class="container">
        <div class="section-head" style="display:flex;align-items:center;gap:10px;justify-content:space-between">
          <h3 style="margin:0">О магазине</h3>
          <button id="editAboutBtn" class="btn btn-outline" title="Вставить текст в раздел">Редактировать текст</button>
        </div>
        <div id="aboutCustom" style="margin-top:10px; line-height:1.6"></div>
        <p id="aboutDefault">Charm Store — уютное пространство, где вы можете выбрать готовые изделия или создать свои — из жемчуга, керамики и других материалов.</p>
        <div style="margin-top:12px">
          <a id="waCta" class="btn btn-primary" target="_blank">Написать в WhatsApp</a>
        </div>
      </div>
    </section>

    <!-- Contact -->
    <section id="contact" class="contact">
      <div class="container">
        <h3>Контакты</h3>
        <form class="contact-form" onsubmit="event.preventDefault(); alert('Спасибо! Мы свяжемся с вами по указанному email.'); this.reset();">
          <label>Ваше имя
            <input type="text" required placeholder="Ваше имя" />
          </label>
          <label>Email
            <input type="email" required placeholder="you@example.com" />
          </label>
          <label>Сообщение
            <textarea rows="4" placeholder="Ваш вопрос"></textarea>
          </label>
          <button class="btn btn-primary" type="submit">Отправить</button>
        </form>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <span>© <span id="year"></span> Charm Store</span>
      <div class="mini-nav">
        <a href="#constructor">Конструктор</a>
        <a href="#catalog">Каталог</a>
        <a href="#about">О магазине</a>
        <a href="#contact">Контакты</a>
      </div>
    </div>
  </footer>

  <!-- Floating WhatsApp -->
  <a id="fabWa" class="fab-wa" target="_blank" aria-label="Написать в WhatsApp">WhatsApp</a>

  <!-- Modals -->
  <dialog id="addModal" class="modal">
    <form id="addProductForm" method="dialog" class="modal-body">
      <h4>Добавить товар</h4>
      <div class="form-grid">
        <label>Название
          <input type="text" name="name" placeholder="Напр. Pearl Blossom" required />
        </label>
        <label>Цена (₸)
          <input type="text" name="price" placeholder="Напр. 12 000 ₸" />
        </label>
        <label>Категория
          <select name="category" required>
            <option value="necklaces">Ожерелья</option>
            <option value="bracelets">Браслеты</option>
            <option value="rings">Кольца</option>
            <option value="chains">Цепочки</option>
          </select>
        </label>
        <label>Фото
          <input type="file" name="image" accept="image/*" required />
        </label>
        <label>Описание
          <textarea name="desc" rows="3" placeholder="Короткое описание (по желанию)"></textarea>
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" value="cancel">Отмена</button>
        <button class="btn btn-primary" value="default" id="submitAdd">Добавить</button>
      </div>
      <p class="hint">Фото и товары сохраняются в вашем браузере (LocalStorage). Внизу можно экспортировать/импортировать каталог.</p>
    </form>
  </dialog>

  <dialog id="aboutModal" class="modal">
    <form id="aboutForm" method="dialog" class="modal-body">
      <h4>Текст для раздела «О магазине»</h4>
      <textarea id="aboutInput" rows="8" style="width:100%; padding:10px; border:1px solid #00000040; border-radius:10px" placeholder="Вставьте сюда свой текст..."></textarea>
      <div class="modal-actions">
        <button class="btn btn-outline" value="cancel">Отмена</button>
        <button class="btn btn-primary" value="default" id="saveAbout">Сохранить</button>
      </div>
    </form>
  </dialog>

  <script>
  // ===== Globals & Storage Keys =====
  const yearSpan = document.getElementById('year'); yearSpan.textContent = new Date().getFullYear();
  const STORAGE_KEY = 'cs2Products';      // готовые товары
  const AVATAR_KEY  = 'cs2Avatar';
  const ABOUT_KEY   = 'cs2AboutText';
  const IG_KEY      = 'cs2Instagram';
  const DESIGN_KEY  = 'cs2Design';
  const WA_NUMBER_RAW = '87785094161'; // Казахстан
  const WA_NUMBER = /^8\\d{10}$/.test(WA_NUMBER_RAW) ? ('7' + WA_NUMBER_RAW.slice(1)) : WA_NUMBER_RAW;
  const WA_URL = `https://wa.me/${WA_NUMBER}`;

  // ===== Sidebar & Header controls =====
  const sidebar = document.getElementById('sidebar');
  const backdrop = document.getElementById('backdrop');
  const openSidebar = document.getElementById('openSidebar');
  const closeSidebar = document.getElementById('closeSidebar');
  const igLink = document.getElementById('igLink');
  const editIG = document.getElementById('editIG');
  const waAnchor = document.getElementById('waLink');
  const waCta = document.getElementById('waCta');
  const fabWa = document.getElementById('fabWa');

  openSidebar.addEventListener('click', () => { sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false') });
  closeSidebar.addEventListener('click', () => { sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true') });
  backdrop.addEventListener('click', () => { sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true') });

  function renderIG(){ const h = localStorage.getItem(IG_KEY) || 'charmstore'; igLink.href = `https://instagram.com/${h}`; }
  if (editIG) editIG.addEventListener('click', () => { const current = localStorage.getItem(IG_KEY) || 'charmstore'; const next = prompt('Введите @username Instagram без @', current); if(next){ localStorage.setItem(IG_KEY, next.replace(/^@/,'')); renderIG(); } });
  renderIG();
  [waAnchor, waCta, fabWa].forEach(a => { if (a) a.href = WA_URL; });

  // ===== Avatar / Favicon =====
  const avatarImg = document.getElementById('avatar');
  const setAvatarBtn = document.getElementById('setAvatarBtn');
  const avatarFile = document.getElementById('avatarFile');
  const favicon = document.getElementById('favicon');
  function placeholderSVG(label){
    const pink = getComputedStyle(document.documentElement).getPropertyValue('--pink').trim();
    const beige = getComputedStyle(document.documentElement).getPropertyValue('--beige').trim();
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='300' height='300'>
      <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
      <stop offset='0%' stop-color='${pink}'/><stop offset='100%' stop-color='${beige}'/></linearGradient></defs>
      <rect width='300' height='300' rx='24' fill='url(#g)' />
      <text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='120' fill='black' opacity='.85'>CS</text>
    </svg>`;
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
  }
  function setDefaultAvatar(){ avatarImg.src = placeholderSVG('CS') }
  function loadAvatar(){ const a = localStorage.getItem(AVATAR_KEY); if(a){ avatarImg.src = a; favicon.href = a } else { setDefaultAvatar() } }
  function saveAvatar(data){ localStorage.setItem(AVATAR_KEY, data); avatarImg.src = data; favicon.href = data }
  setAvatarBtn.addEventListener('click', () => avatarFile.click());
  avatarFile.addEventListener('change', () => { const f = avatarFile.files[0]; if(!f) return; const r = new FileReader(); r.onload=()=>saveAvatar(r.result); r.readAsDataURL(f) });
  loadAvatar();

  // ===== About text editor =====
  const DEFAULT_ABOUT = `Добро пожаловать в Charm Store — уютное пространство, где каждая деталь создана с любовью и вдохновением. Мы верим, что украшения должны не просто дополнять образ, а отражать индивидуальность и настроение своей обладательницы.
  
Наши изделия изготавливаются вручную из натурального жемчуга, керамических бусин и других материалов. Мы тщательно подбираем фурнитуру, чтобы каждая вещь была красивой и комфортной в носке.
  
Создайте свою коллекцию в нашем конструкторе — и подчеркните индивидуальность с Charm Store.`;
  const aboutBtn = document.getElementById('editAboutBtn');
  const aboutModal = document.getElementById('aboutModal');
  const aboutInput = document.getElementById('aboutInput');
  const aboutCustom = document.getElementById('aboutCustom');
  const aboutDefault = document.getElementById('aboutDefault');
  const saveAbout = document.getElementById('saveAbout');
  if(!localStorage.getItem(ABOUT_KEY)){ localStorage.setItem(ABOUT_KEY, DEFAULT_ABOUT); }
  function renderAbout(){ const t = localStorage.getItem(ABOUT_KEY); if(t && t.trim()){ aboutCustom.innerText = t; aboutDefault.style.display='none' } else { aboutCustom.innerText=''; aboutDefault.style.display=''; } }
  aboutBtn.addEventListener('click', () => { aboutInput.value = localStorage.getItem(ABOUT_KEY)||''; aboutModal.showModal() });
  saveAbout.addEventListener('click', (e) => { e.preventDefault(); localStorage.setItem(ABOUT_KEY, aboutInput.value||''); aboutModal.close(); renderAbout() });
  renderAbout();

  // ===== Catalog (готовые товары) =====
  const grid = document.getElementById('productsGrid');
  const emptyState = document.getElementById('emptyState');
  const filters = document.querySelectorAll('.filter-btn');
  filters.forEach(btn => btn.addEventListener('click', () => { filters.forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderCatalog(btn.dataset.filter); }));
  function getProducts(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw): [] }catch(e){ return [] } }
  function saveProducts(items){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)) }
  function productCard(p){
    const el = document.createElement('article'); el.className='card';
    const img = document.createElement('img'); img.className='card-img';
    img.src = p.image || placeholderSVG((p.category||'Товар'));
    img.alt = p.name || 'Украшение';
    const body = document.createElement('div'); body.className='card-body';
    const t = document.createElement('h4'); t.className='card-title'; t.textContent = p.name || 'Без названия';
    const price = document.createElement('div'); price.className='card-price'; price.textContent = p.price || '';
    const desc = document.createElement('p'); desc.className='card-desc'; desc.textContent = p.desc || '';
    body.appendChild(t); if(p.price) body.appendChild(price); if(p.desc) body.appendChild(desc);
    el.appendChild(img); el.appendChild(body); return el;
  }
  function renderCatalog(filter='all'){
    const items = getProducts(); grid.innerHTML='';
    const visible = items.filter(p => filter==='all' ? true : p.category===filter);
    if(visible.length===0){ emptyState.hidden=false } else { emptyState.hidden=true; visible.forEach(p => grid.appendChild(productCard(p))) }
  }
  // seed placeholders
  (function seed(){
    const exists = getProducts(); if(exists.length>0){ renderCatalog('all'); return }
    const placeholders = [
      {name:'Pearl Blossom', price:'12 000 ₸', category:'necklaces', desc:'Натуральный жемчуг, фурнитура под золото.'},
      {name:'Minimal Chain', price:'7 500 ₸', category:'chains', desc:'Тонкая цепочка, гипоаллергенная сталь.'},
      {name:'Rose Quartz', price:'9 900 ₸', category:'bracelets', desc:'Браслет с розовым кварцем.'},
      {name:'Dainty Ring', price:'6 000 ₸', category:'rings', desc:'Аккуратное кольцо, регулируемый размер.'}
    ];
    saveProducts(placeholders); renderCatalog('all');
  })();

  // Add product modal
  const addModal = document.getElementById('addModal');
  const openAdd = document.getElementById('openAddModal');
  const addForm = document.getElementById('addProductForm');
  const submitAdd = document.getElementById('submitAdd');
  openAdd.addEventListener('click', () => addModal.showModal());
  addForm.addEventListener('submit', async (e) => {
    if(e.submitter !== submitAdd) return; e.preventDefault();
    const fd = new FormData(addForm);
    const name = fd.get('name'); const price = fd.get('price'); const category = fd.get('category'); const desc = fd.get('desc'); const file = fd.get('image');
    if(!file || !file.size){ alert('Пожалуйста, выберите фото.'); return }
    const image = await fileToDataURL(file);
    const items = getProducts(); items.unshift({name, price, category, desc, image});
    saveProducts(items); addForm.reset(); addModal.close();
    const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all'; renderCatalog(activeFilter);
  });
  function fileToDataURL(file){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file) }) }

  // ===== Constructor =====
  const materials = [
    // id, name, color, price (KZT), size mm, category
    {id:'pearl-6', name:'Жемчуг 6мм', color:'#f7f3f0', price:350, size:6, group:'Жемчуг'},
    {id:'pearl-8', name:'Жемчуг 8мм', color:'#f3ede9', price:450, size:8, group:'Жемчуг'},
    {id:'ceramic-pink', name:'Керамика розовая 8мм', color:'#F7C9D4', price:200, size:8, group:'Керамика'},
    {id:'ceramic-beige', name:'Керамика бежевая 8мм', color:'#F5E9E2', price:200, size:8, group:'Керамика'},
    {id:'ceramic-white', name:'Керамика белая 8мм', color:'#ffffff', price:200, size:8, group:'Керамика'},
    {id:'spacer-gold', name:'Разделитель золото 4мм', color:'#e7d18a', price:120, size:4, group:'Фурнитура'},
    {id:'spacer-heart', name:'Сердечко золото 6мм', color:'#e1c76d', price:220, size:6, group:'Фурнитура'},
    {id:'crystal-clear', name:'Кристалл прозрачный 6мм', color:'#e6f4ff', price:280, size:6, group:'Кристаллы'}
  ];
  const typePresets = {
    keychain: {label:'Брелок', targetCm:12},
    bracelet: {label:'Браслет', targetCm:17},
    necklace: {label:'Ожерелье', targetCm:40}
  };

  const beadsList = document.getElementById('beadsList');
  function renderMaterials(){
    beadsList.innerHTML='';
    materials.forEach(m => {
      const b = document.createElement('button'); b.className='bead'; b.type='button';
      const sw = document.createElement('span'); sw.className='sw'; sw.style.background = m.color;
      b.appendChild(sw); b.appendChild(document.createTextNode(`${m.name} • ${m.price} ₸`));
      b.addEventListener('click', () => addBeadToDesign(m.id));
      beadsList.appendChild(b);
    });
  }
  renderMaterials();

  let design = JSON.parse(localStorage.getItem(DESIGN_KEY) || '[]'); // array of bead ids
  let currentType = 'bracelet';
  let currentLength = typePresets[currentType].targetCm;

  // type & size chips
  document.querySelectorAll('[data-type]').forEach(ch => {
    ch.addEventListener('click', () => {
      document.querySelectorAll('[data-type]').forEach(c=>c.classList.remove('active'));
      ch.classList.add('active');
      currentType = ch.getAttribute('data-type');
      // set a default length
      currentLength = typePresets[currentType].targetCm;
      updateTotals();
    });
  });
  document.querySelectorAll('[data-size]').forEach(ch => {
    ch.addEventListener('click', () => {
      document.querySelectorAll('[data-size]').forEach(c=>c.classList.remove('active'));
      ch.classList.add('active');
      const v = ch.getAttribute('data-size').split(':');
      currentType = v[0]; currentLength = Number(v[1]);
      document.querySelectorAll('[data-type]').forEach(c=>c.classList.toggle('active', c.getAttribute('data-type')===currentType));
      updateTotals();
    });
  });
  // set defaults
  document.querySelector('[data-type="bracelet"]').classList.add('active');
  document.querySelector('[data-size="bracelet:17"]').classList.add('active');

  const strand = document.getElementById('strand');
  const t_type = document.getElementById('t_type');
  const t_length = document.getElementById('t_length');
  const t_count = document.getElementById('t_count');
  const t_price = document.getElementById('t_price');

  function addBeadToDesign(id){
    design.push(id);
    saveDesign(); renderDesign();
  }
  function moveBead(index, dir){
    const j = index + dir;
    if(j<0 || j>=design.length) return;
    const tmp = design[index]; design[index]=design[j]; design[j]=tmp;
    saveDesign(); renderDesign();
  }
  function removeBead(index){ design.splice(index,1); saveDesign(); renderDesign(); }
  function saveDesign(){ localStorage.setItem(DESIGN_KEY, JSON.stringify(design)); }

  function renderDesign(){
    strand.innerHTML='';
    design.forEach((id, idx) => {
      const m = materials.find(x=>x.id===id);
      const pill = document.createElement('div'); pill.className='bead-pill';
      const sw = document.createElement('span'); sw.className='sw'; sw.style.background=m.color;
      const name = document.createElement('span'); name.textContent = m ? m.name : id;
      const actions = document.createElement('span'); actions.className='pill-actions';
      const left = document.createElement('button'); left.textContent='◀'; left.title='Влево'; left.addEventListener('click', ()=>moveBead(idx,-1));
      const right= document.createElement('button'); right.textContent='▶'; right.title='Вправо'; right.addEventListener('click', ()=>moveBead(idx,+1));
      const del  = document.createElement('button'); del.textContent='✕'; del.title='Удалить'; del.addEventListener('click', ()=>removeBead(idx));
      actions.appendChild(left); actions.appendChild(right); actions.appendChild(del);
      pill.appendChild(sw); pill.appendChild(name); pill.appendChild(actions);
      strand.appendChild(pill);
    });
    updateTotals();
  }

  function calcTotals(){
    const sumPrice = design.reduce((s,id)=> s + (materials.find(m=>m.id===id)?.price||0), 0);
    const mmSum = design.reduce((s,id)=> s + (materials.find(m=>m.id===id)?.size||0), 0);
    const cmApprox = (mmSum/10).toFixed(1);
    return {sumPrice, cmApprox};
  }
  function updateTotals(){
    const info = typePresets[currentType] || {label:currentType};
    const {sumPrice, cmApprox} = calcTotals();
    t_type.textContent = info.label || currentType;
    t_length.textContent = `${currentLength} см (≈${cmApprox} см собрано)`;
    t_count.textContent = String(design.length);
    t_price.textContent = `${sumPrice.toLocaleString('ru-RU')} ₸`;
  }
  renderDesign();

  // Import/Export/Clear
  document.getElementById('exportDesign').addEventListener('click', () => {
    const payload = {type: currentType, targetLength: currentLength, beads: design};
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'charm-store-design.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  });
  document.getElementById('importDesign').addEventListener('click', () => document.getElementById('importFile').click());
  document.getElementById('importFile').addEventListener('change', () => {
    const f = document.getElementById('importFile').files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try{
        const data = JSON.parse(r.result);
        design = Array.isArray(data.beads) ? data.beads : [];
        currentType = data.type || currentType;
        currentLength = Number(data.targetLength) || currentLength;
        saveDesign(); renderDesign();
        alert('Дизайн импортирован!');
      }catch(e){ alert('Ошибка импорта: '+e.message) }
    };
    r.readAsText(f);
  });
  document.getElementById('clearDesign').addEventListener('click', () => {
    if(confirm('Очистить текущий дизайн?')){ design = []; saveDesign(); renderDesign(); }
  });

  // WhatsApp order
  document.getElementById('orderWA').addEventListener('click', () => {
    if(design.length===0){ alert('Добавьте бусины в дизайн.'); return }
    const note = document.getElementById('userNote').value || '';
    const counts = {}; design.forEach(id => counts[id]=(counts[id]||0)+1);
    const lines = Object.entries(counts).map(([id,cnt]) => {
      const m = materials.find(x=>x.id===id); return `• ${m?m.name:id} × ${cnt}`;
    }).map(s=>encodeURIComponent(s)).join('%0A');
    const {sumPrice, cmApprox} = calcTotals();
    const typeLabel = (typePresets[currentType]?.label)||currentType;
    const msg =
`Здравствуйте! Хочу заказать кастомное изделие в Charm Store.%0A
Тип: ${encodeURIComponent(typeLabel)}%0A
Длина: ${encodeURIComponent(currentLength + ' см (≈' + cmApprox + ' см собрано)')}%0A
Состав:%0A${lines}%0A
Итог: ${encodeURIComponent(sumPrice.toLocaleString('ru-RU') + ' ₸')}%0A
Комментарий: ${encodeURIComponent(note)}`;
    window.open(`${WA_URL}?text=${msg}`, '_blank');
  });

  // ===== Utils =====
  </script>
</body>
</html>
